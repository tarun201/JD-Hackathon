<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Group 15 Video Checker</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-4xl mx-auto py-10 px-4">
    <h1 class="text-3xl font-bold text-center mb-8">üé• Group 15 Video Checker</h1>

    <form id="uploadForm" class="bg-white p-6 rounded-xl shadow-md mb-6">
      <label class="block text-lg font-semibold mb-2">Upload Videos</label>
      <input type="file" name="videos" id="videoInput" multiple accept="video/*"
             class="w-full mb-4 border border-gray-300 p-2 rounded-md"/>
      <button type="submit"
              class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        Upload and Check
      </button>
    </form>

    <div id="results" class="space-y-6"></div>
  </div>

  <script>
    const uploadForm = document.getElementById('uploadForm');
    const videoInput = document.getElementById('videoInput');
    const resultsContainer = document.getElementById('results');

    let uploadIds = [];
    let pollIntervalId = null;

    async function pollStatus() {
      if (!uploadIds.length) return;
      const res = await fetch('/status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ uploadIds }),
      });
      const statusData = await res.json();
      console.log({statusData});
      let allDone = true;
      statusData.statuses.forEach(item => {
        const box = document.getElementById(`result-${item.uploadId}`);
        if (item.status === 'done') {
          box.innerHTML = `
            <h2 class="text-xl font-semibold mb-2">Upload ID: ${item.uploadId}</h2>
            <ul class="space-y-1 text-sm">
              ${Object.entries(item.results).map(([check, result]) => {
                const color = result === true || result === 'ok' || result === 'clear' || result === 'motion' || result === '16:9'
                  ? 'text-green-600' : 'text-red-600';
                return `<li><strong>${check}:</strong> <span class="${color}">${result}</span></li>`;
              }).join('')}
            </ul>
          `;
        } else {
          allDone = false;
          if (box) box.querySelector('p').innerText = '‚è≥ Checking...';
        }
      });

      if (allDone && pollIntervalId) {
        clearInterval(pollIntervalId);
        pollIntervalId = null;
      }
    }

    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const files = videoInput.files;
      if (files.length === 0) return alert('Please select at least one video.');

      const formData = new FormData();
      for (const file of files) {
        formData.append('videos', file);
      }
      
      resultsContainer.innerHTML = 'uploading...';

      const response = await fetch('/upload-bulk', {
        method: 'POST',
        body: formData,
      });

      const data = await response.json();

      uploadIds = data.uploadIds || [data.uploadIds];

      if(uploadIds) {
        resultsContainer.innerHTML = '';
      }
      uploadIds.forEach(id => {
        const resultBox = document.createElement('div');
        resultBox.id = `result-${id}`;
        resultBox.className = 'bg-white p-4 rounded-xl shadow';
        resultBox.innerHTML = `<h2 class="text-xl font-semibold mb-2">Upload ID: ${id}</h2>
                              <p class="text-sm text-gray-500">‚è≥ Checking...</p>`;
        resultsContainer.appendChild(resultBox);
      });

      // Clear previous polling interval if any
      if (pollIntervalId) clearInterval(pollIntervalId);

      // Start polling
      pollIntervalId = setInterval(pollStatus, 3000);
      pollStatus(); // Call once immediately
    });
  </script>
</body>
</html>
