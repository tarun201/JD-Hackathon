<html>
<head>
  <title>User Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body class="bg-light">
  <div class="container mt-5">
    <div class="card shadow-lg">
      <div class="card-header bg-primary text-white">
        <h3 class="mb-0">ğŸ‘¤ Details Data</h3>
	<video id="video"></video>
      </div>
      <div class="card-body" id="user-details">
        <p>Loading user details...</p>
      </div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');

 	if (Hls.isSupported()) {
            var video = document.getElementById('video');
            var hls = new Hls();
            hls.loadSource('/uploads/1754177775100-82682372-gym_women.mp4');
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                video.play();
            });
        }
    
fetch(`/details?id=${id}`)
  .then(response => response.json())
  .then(userdetails => {
    let decision = '';
    user = userdetails[0];
    if (user.decision === 0) {
      decision = 'Pending';
    } else if (user.decision === 1) {
      decision = 'Approved';
    } else if (user.decision === 2) {
      decision = 'Rejected';
    }

    let issue = '';
    let avgscore = 0;
    let cntscore = 0;

    if (user.detailed_issue_detected.nudity !== undefined) {
      issue += 'Nudity ';
      for (const key in user.detailed_issue_detected.nudity.details) {
        issue += user.detailed_issue_detected.nudity.details[key].lvl;
        issue += ' in ' + user.detailed_issue_detected.nudity.details[key].frame_time_in_sec + ' secs ';
        avgscore += user.detailed_issue_detected.nudity.details[key].avgscore;
        cntscore++;
      }
    }
    if (user.detailed_issue_detected.branding !== undefined) {
      issue += '<br>Branding ';
      for (const key in user.detailed_issue_detected.branding.details) {
        issue += user.detailed_issue_detected.branding.details[key].lvl;
        issue += ' in ' + user.detailed_issue_detected.branding.details[key].frame_time_in_sec + ' secs ';
        avgscore += user.detailed_issue_detected.branding.details[key].avgscore;
        cntscore++;
      }
    }
    if (user.detailed_issue_detected.watermark !== undefined) {
      issue += '<br>Watermark ';
      for (const key in user.detailed_issue_detected.watermark.details) {
        issue += user.detailed_issue_detected.watermark.details[key].lvl;
        issue += ' in ' + user.detailed_issue_detected.watermark.details[key].frame_time_in_sec + ' secs ';
        avgscore += user.detailed_issue_detected.watermark.details[key].avgscore;
        cntscore++;
      }
    }
    if (user.detailed_issue_detected.contact_number !== undefined) {
      issue += '<br>Contact Number Found ';
      for (const key in user.detailed_issue_detected.contact_number.details) {
        issue += user.detailed_issue_detected.contact_number.details[key].lvl;
        issue += ' in ' + user.detailed_issue_detected.contact_number.details[key].frame_time_in_sec + ' secs ';
        avgscore += user.detailed_issue_detected.contact_number.details[key].avgscore;
        cntscore++;
      }
    }
    if (user.detailed_issue_detected.empty === 1) {
      issue += '<br>Blank/empty frames, ';
    }
    if (user.detailed_issue_detected.blurry === 1) {
      issue += '<br>Blurry/out of Focus frames, ';
    }
    if (user.detailed_issue_detected.audio !== 'ok' && user.detailed_issue_detected.audio !== undefined) {
      issue += '<br>'+user.detailed_issue_detected.audio + ', ';
    }
    if (user.detailed_issue_detected.cropping_needed === 1) {
      issue += '<br>Video with Black bars, ';
    }
    if (user.detailed_issue_detected.duplicate === 1) {
      issue += '<br>Duplicate video uploaded, ';
    }

    const container = document.getElementById('user-details');
    container.innerHTML = `
      <p><strong>Video Id:</strong> ${user._id}</p>
      <p><strong>Upload date:</strong> ${new Date(user.upload_date).toLocaleString()}</p>
      <p><strong>Decision:</strong> ${decision}</p>

      <h4>AI Moderation Details</h4>

      <p><strong>Detected issue:</strong> ${issue}</p>
      <p><strong>Confidence Score:</strong> ${(cntscore > 0 ? (avgscore / cntscore).toFixed(2) : 'N/A')}</p>
      <p><strong>Raw Output:</strong> ${user.raw}</p>
    `;
  })
  .catch(err => {
    document.getElementById('user-details').innerText = 'Failed to load user data.';
  });
</script>
</body>
</html>
